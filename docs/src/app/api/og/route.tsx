import { ImageResponse } from "@vercel/og";
import { z } from "zod";
export const runtime = "edge";

const ogSchema = z.object({
  heading: z.string(),
  mode: z.string(),
  type: z.string(),
});

export async function GET(req: Request) {
  try {
    const geist = await fetch(
      new URL("../../../../public/Geist.ttf", import.meta.url)
    ).then((res) => res.arrayBuffer());
    const geistMono = await fetch(
      new URL("../../../../public/GeistMono.ttf", import.meta.url)
    ).then((res) => res.arrayBuffer());
    const url = new URL(req.url);
    const urlParamsValues = Object.fromEntries(url.searchParams);
    const validParams = ogSchema.parse(urlParamsValues);
    const { heading, type } = validParams;
    const trueHeading =
      heading.length > 140 ? `${heading.substring(0, 140)}...` : heading;

    const paint = "#fff";

    const fontSize = trueHeading.length > 100 ? "30px" : "60px";
    return new ImageResponse(
      (
        <div
          tw="flex w-full relative flex-col p-9"
          style={{
            color: paint,
            backgroundColor: "transparent",
            border: "1px solid rgba(255, 255, 255, 0.1)",
            boxShadow: "0 -20px 80px -20px rgba(28, 12, 12, 0.1) inset",
            background: "#0a0505",
          }}
        >
          <div
            tw={`relative flex flex-col w-full h-full border-2 border-[${paint}]/20 p-8}`}
          >
            <svg
              style={{
                position: "absolute",
                top: "-9px",
                right: "-9px",
              }}
              width="17"
              height="17"
              fill="none"
            >
              <path
                d="M7 1a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v2a1 1 0 0 1-1 1H1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h2a1 1 0 0 1 1 1v2a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V8a1 1 0 0 1 1-1h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H8a1 1 0 0 1-1-1V1z"
                fill="#d0cfd1d3"
              />
            </svg>

            <svg
              style={{
                position: "absolute",
                top: "-9px",
                left: "-9px",
              }}
              width="17"
              height="17"
              fill="none"
            >
              <path
                d="M7 1a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v2a1 1 0 0 1-1 1H1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h2a1 1 0 0 1 1 1v2a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V8a1 1 0 0 1 1-1h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H8a1 1 0 0 1-1-1V1z"
                fill="#cacaca"
              />
            </svg>
            <svg
              style={{
                position: "absolute",
                bottom: "-9px",
                left: "-9px",
              }}
              width="17"
              height="17"
              fill="none"
            >
              <path
                d="M7 1a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v2a1 1 0 0 1-1 1H1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h2a1 1 0 0 1 1 1v2a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V8a1 1 0 0 1 1-1h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H8a1 1 0 0 1-1-1V1z"
                fill="#cacaca"
              />
            </svg>
            <svg
              style={{
                position: "absolute",
                bottom: "-9px",
                right: "-9px",
              }}
              width="17"
              height="17"
              fill="none"
            >
              <path
                d="M7 1a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v2a1 1 0 0 1-1 1H1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1h2a1 1 0 0 1 1 1v2a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1V8a1 1 0 0 1 1-1h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H8a1 1 0 0 1-1-1V1z"
                fill="#cacaca"
              />
            </svg>
            <div tw="flex flex-col flex-1 py-10">
              <svg
                width="100px"
                height="76px"
                viewBox="0 0 500 382"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                xmlnsXlink="http://www.w3.org/1999/xlink"
              >
                <g
                  id="Page-1"
                  stroke="none"
                  strokeWidth="1"
                  fill="none"
                  fillRule="evenodd"
                >
                  <g
                    id="Group"
                    transform="translate(0.000000, 0.690151)"
                    fillRule="nonzero"
                    fill="currentColor"
                  >
                    <g>
                      <g id="Path">
                        <path d="M134.341747,336.163884 L42.1615937,285.128024 C41.017075,284.475239 40.3056174,283.318031 40.3056174,282.042134 L40.3056174,203.233272 C40.3056174,201.868359 41.8522643,201.007871 43.0895818,201.690327 L150.117545,260.975006 C151.602326,261.805823 153.489235,260.767302 153.489235,259.105669 L153.489235,220.650742 C153.489235,219.107798 152.623113,217.713213 151.262064,216.941741 L22.4573125,145.580553 C21.3127939,144.927769 19.8898787,144.927769 18.7144271,145.580553 L1.85597624,154.927237 C0.71145756,155.580021 -1.42108547e-14,156.737229 -1.42108547e-14,158.013126 L-1.42108547e-14,304.503847 C-1.42108547e-14,305.779744 0.71145756,306.966624 1.85597624,307.589736 L134.094284,380.820261 C135.238802,381.473045 136.661717,381.473045 137.837169,380.820261 L248.886414,319.310181 C250.371195,318.479365 250.371195,316.431996 248.886414,315.60118 L214.241524,296.403388 C212.849542,295.631916 211.148231,295.631916 209.756248,296.403388 L138.0537,336.10454 C136.909181,336.757324 135.486266,336.757324 134.310814,336.10454 L134.341747,336.163884 Z"></path>
                        <path
                          d="M384.341747,336.163884 L292.161594,285.128024 C291.017075,284.475239 290.305617,283.318031 290.305617,282.042134 L290.305617,203.233272 C290.305617,201.868359 291.852264,201.007871 293.089582,201.690327 L400.117545,260.975006 C401.602326,261.805823 403.489235,260.767302 403.489235,259.105669 L403.489235,220.650742 C403.489235,219.107798 402.623113,217.713213 401.262064,216.941741 L272.457313,145.580553 C271.312794,144.927769 269.889879,144.927769 268.714427,145.580553 L251.855976,154.927237 C250.711458,155.580021 250,156.737229 250,158.013126 L250,304.503847 C250,305.779744 250.711458,306.966624 251.855976,307.589736 L384.094284,380.820261 C385.238802,381.473045 386.661717,381.473045 387.837169,380.820261 L498.886414,319.310181 C500.371195,318.479365 500.371195,316.431996 498.886414,315.60118 L464.241524,296.403388 C462.849542,295.631916 461.148231,295.631916 459.756248,296.403388 L388.0537,336.10454 C386.909181,336.757324 385.486266,336.757324 384.310814,336.10454 L384.341747,336.163884 Z"
                          transform="translate(375.000000, 263.200407) scale(-1, 1) translate(-375.000000, -263.200407) "
                        ></path>
                        <path d="M68.8397254,7.10542736e-13 L221.922795,0.0223623876 C223.257407,0.00600478646 224.492634,0.688035439 225.17198,1.81639954 L265.628219,68.836519 C266.483077,70.2672273 265.413391,72.039108 263.690383,72.0464479 L223.946587,72.0492667 C222.335143,72.049728 220.858241,71.2342566 220.052936,69.8993875 L201.931509,39.8979256 C201.279015,38.7843883 200.043788,38.1023576 198.682324,38.1038885 L91.9964519,38.0887843 C90.6618403,38.1051419 89.4396217,38.7656244 88.773006,39.8698399 L47.38082,108.43392 C46.57468,109.76925 45.0941761,110.561034 43.5095844,110.576322 L3.8349971,110.583138 C2.11198897,110.590455 1.01656444,108.787243 1.88471516,107.349195 L65.6007768,1.80673502 C66.2673925,0.7025195 67.5051138,0.0163576012 68.8242227,0.0256794306 L68.8397254,7.10542736e-13 Z"></path>
                        <path d="M432.33604,2.84217094e-14 L279.25297,0.0223623876 C277.918359,0.00600478645 276.683131,0.688035439 276.003785,1.81639954 L235.547546,68.836519 C234.692689,70.2672273 235.762375,72.039108 237.485383,72.0464479 L277.229178,72.0492667 C278.840623,72.049728 280.317525,71.2342566 281.122829,69.8993875 L299.244257,39.8979256 C299.89675,38.7843883 301.131977,38.1023576 302.493442,38.1038885 L409.179314,38.0887843 C410.513925,38.1051419 411.736144,38.7656244 412.40276,39.8698399 L453.794946,108.43392 C454.601086,109.76925 456.081589,110.561034 457.666181,110.576322 L497.340768,110.583138 C499.063777,110.590455 500.159201,108.787243 499.29105,107.349195 L435.574989,1.80673502 C434.908373,0.7025195 433.670652,0.0163576012 432.351543,0.0256794306 L432.33604,2.84217094e-14 Z"></path>
                      </g>
                      <g
                        transform="translate(184.000000, 118.309849)"
                        id="Rectangle"
                      >
                        <path
                          d="M48,-46 L85,-46 C86.1045695,-46 87,-45.1045695 87,-44 L87,85 C87,86.1045695 86.1045695,87 85,87 L48,87 C46.8954305,87 46,86.1045695 46,85 L46,-44 C46,-45.1045695 46.8954305,-46 48,-46 Z"
                          transform="translate(66.500000, 20.500000) rotate(90.000000) translate(-66.500000, -20.500000) "
                        ></path>
                        <path d="M2,2.27373675e-13 L41,2.27373675e-13 C42.1045695,2.27373675e-13 43,0.8954305 43,2 L43,83 C43,84.1045695 42.1045695,85 41,85 L2,85 C0.8954305,85 -1.33226763e-15,84.1045695 0,83 L0,2 C0,0.8954305 0.8954305,2.29816166e-13 2,2.27373675e-13 Z"></path>
                        <path d="M92,2.27373675e-13 L131,2.27373675e-13 C132.104569,2.27373675e-13 133,0.8954305 133,2 L133,83 C133,84.1045695 132.104569,85 131,85 L92,85 C90.8954305,85 90,84.1045695 90,83 L90,2 C90,0.8954305 90.8954305,2.29816166e-13 92,2.27373675e-13 Z"></path>
                        <path
                          d="M37.5638852,88 L96.4361148,88 C97.3276335,88 97.6509198,88.0928256 97.9768457,88.2671327 C98.3027716,88.4414398 98.5585602,88.6972284 98.7328673,89.0231543 C98.9071744,89.3490802 99,89.6723665 99,90.5638852 L99,136.436115 C99,137.327634 98.9071744,137.65092 98.7328673,137.976846 C98.5585602,138.302772 98.3027716,138.55856 97.9768457,138.732867 C97.6509198,138.907174 97.3276335,139 96.4361148,139 L37.5638852,139 C36.6723665,139 36.3490802,138.907174 36.0231543,138.732867 C35.6972284,138.55856 35.4414398,138.302772 35.2671327,137.976846 C35.0928256,137.65092 35,137.327634 35,136.436115 L35,90.5638852 C35,89.6723665 35.0928256,89.3490802 35.2671327,89.0231543 C35.4414398,88.6972284 35.6972284,88.4414398 36.0231543,88.2671327 C36.3490802,88.0928256 36.6723665,88 37.5638852,88 Z"
                          transform="translate(67.000000, 113.500000) rotate(90.000000) translate(-67.000000, -113.500000) "
                        ></path>
                      </g>
                    </g>
                  </g>
                </g>
              </svg>

              <div
                style={{ fontFamily: "GeistMono", fontWeight: "normal" }}
                tw="relative flex mt-10 text-xl uppercase font-bold gap-2 items-center"
              >
                {type === "documentaiton" ? (
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="1.2em"
                    height="1.2em"
                    viewBox="0 0 24 24"
                  >
                    <path
                      fill="currentColor"
                      fillRule="evenodd"
                      d="M4.172 3.172C3 4.343 3 6.229 3 10v4c0 3.771 0 5.657 1.172 6.828S7.229 22 11 22h2c3.771 0 5.657 0 6.828-1.172S21 17.771 21 14v-4c0-3.771 0-5.657-1.172-6.828S16.771 2 13 2h-2C7.229 2 5.343 2 4.172 3.172M8 9.25a.75.75 0 0 0 0 1.5h8a.75.75 0 0 0 0-1.5zm0 4a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5z"
                      clipRule="evenodd"
                    ></path>
                  </svg>
                ) : null}
                {type}
              </div>
              <div
                tw="flex max-w-[70%] mt-5 tracking-tighter leading-[1.1] text-[30px] font-bold"
                style={{
                  fontWeight: "bold",
                  marginLeft: "-3px",
                  fontSize,

                  fontFamily: "GeistMono",
                }}
              >
                {trueHeading}
              </div>
            </div>

            <div tw="flex items-center w-full justify-between">
              <div
                tw="flex text-xl"
                style={{ fontFamily: "GeistSans", fontWeight: "semibold" }}
              >
                Payload Auth.
              </div>
              <div tw="flex gap-2 items-center text-xl">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="1.2em"
                  height="1.2em"
                  viewBox="0 0 24 24"
                >
                  <path
                    fill="currentColor"
                    d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"
                  ></path>
                </svg>
                <span
                  style={{
                    fontFamily: "GeistSans",
                  }}
                  tw="flex ml-2"
                >
                  github.com/forrestdevs/payload-better-auth
                </span>
              </div>
            </div>
          </div>
        </div>
      ),
      {
        width: 1200,
        height: 630,
        fonts: [
          {
            name: "Geist",
            data: geist,
            weight: 400,
            style: "normal",
          },
          {
            name: "GeistMono",
            data: geistMono,
            weight: 700,
            style: "normal",
          },
        ],
      }
    );
  } catch (err) {
    console.log({ err });
    return new Response("Failed to generate the og image", { status: 500 });
  }
}
